<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Program pražských art kin</title>
  <style>
    :root { --w: 920px }
    body { font-family: system-ui, sans-serif; margin: 2rem auto; max-width: var(--w); padding: 0 1rem }
    h1 { margin: 0 0 1rem 0 }
    .row { display: flex; gap: .75rem; flex-wrap: wrap; align-items: center; margin-bottom: .75rem }
    .cinemas { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: .5rem; margin-bottom: .5rem }
    .card { border: 1px solid #e5e7eb; border-radius: .75rem; padding: .9rem }
    .results { display: grid; gap: .75rem }
    .film { border: 1px solid #e5e7eb; border-radius: .75rem; padding: .9rem }
    .film-title { font-weight: 700; margin-bottom: .35rem }
    .show { display: flex; justify-content: space-between; padding: .3rem .4rem; border-bottom: 1px solid #f3f4f6 }
    .show:last-child { border-bottom: 0 }
    .muted { color: #666 }
    .small { font-size: .9rem }
    input[type="search"], input[type="date"], select, button { padding: .55rem .7rem }
    button { cursor: pointer }
    .error { color: #b00020 }
    progress { width: 220px; height: 10px }
  </style>
</head>
<body>
  <div style="text-align:center; margin-bottom: 1rem;">
    <img src="logo.png" alt="Logo projektu" style="width: 300px; height: auto;">
  </div>

  <h1>Program pražských art kin</h1>

  <div class="card">
    <div class="row">
      <label><strong>Od data</strong></label>
      <input id="dateFrom" type="date" />
      <label><strong>Rozsah</strong></label>
      <select id="range">
        <option value="1" selected>1 den</option>
        <option value="7">7 dní</option>
        <option value="14">14 dní</option>
      </select>
      <label><strong>Hledat film</strong></label>
      <input id="q" type="search" placeholder="název filmu" />
      <button id="loadBtn">Načíst</button>
      <span id="hint" class="muted small">Vyhledávání ignoruje diakritiku</span>
    </div>

    <div class="cinemas small muted">Vybraná kina</div>
    <div id="cinemaList" class="cinemas"></div>

    <div class="row small">
      <span id="status" class="muted"></span>
      <progress id="prog" value="0" max="100" style="display:none"></progress>
    </div>
  </div>

  <div id="out" class="results" aria-live="polite"></div>

  <script>
    // Seznam kin – kavalírka odebrána
    const CINEMAS = [
      { id: "atlas",     name: "Kino Atlas" },
      { id: "aero",      name: "Kino Aero" },
      { id: "svetozor",  name: "Kino Světozor" },
      { id: "oko",       name: "Bio Oko" },
      { id: "edison",    name: "Edison Filmhub" },
      { id: "pilotu",    name: "Kino Pilotů" },
      { id: "ponrepo",   name: "Ponrepo" },
      { id: "mat",       name: "Kino Mat" },
      { id: "lucerna",   name: "Kino Lucerna" }
    ];

    const ENDPOINTS = {
      atlas:     d => `/api/program?cinema=atlas&date=${d}`,
      aero:      d => `/api/program?cinema=aero&date=${d}`,
      svetozor:  d => `/api/program?cinema=svetozor&date=${d}`,
      oko:       d => `/api/program?cinema=oko&date=${d}`,
      edison:    d => `/api/program?cinema=edison&date=${d}`,
      pilotu:    d => `/api/program?cinema=pilotu&date=${d}`,
      ponrepo:   d => `/api/program?cinema=ponrepo&date=${d}`,
      mat:       d => `/api/program?cinema=mat&date=${d}`,
      lucerna:   d => `/api/program?cinema=lucerna&date=${d}`
    };
function fmtLocalDate(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

    // Funkce pro načítání programu
    async function loadProgramForCinema(cinemaId, date) {
      if (cinemaId === "atlas" || cinemaId === "svetozor" || cinemaId === "lucerna" || cinemaId === "aero" || cinemaId === "edison" || cinemaId === "ponrepo" || cinemaId === "pilotu" || cinemaId === "mat") {
        const r = await fetch(ENDPOINTS[cinemaId](date));
        if (!r.ok) {
          const t = await r.text();
          throw new Error(`${cinemaId} API: ${r.status} ${t.slice(0,120)}`);
        }
        return r.json();
      }
      return demoData(cinemaId, date);
    }

    // Demo fallback
    function demoData(cinemaId, date) {
      return [];
    }

    // UI – checkboxy pro výběr kin
    const listEl = document.getElementById("cinemaList");
    listEl.innerHTML = '<label><input type="checkbox" id="allCinemas"> Všechny</label>';
    CINEMAS.forEach(c => {
      const lbl = document.createElement("label");
      lbl.innerHTML = `<input type="checkbox" value="${c.id}"> ${c.name}`;
      listEl.appendChild(lbl);
    });

    // Checkbox „Všechny“
    document.getElementById("allCinemas").addEventListener("change", e => {
      const checked = e.target.checked;
      listEl.querySelectorAll("input[type=checkbox]").forEach(cb => {
        if (cb.id !== "allCinemas") cb.checked = checked;
      });
    });

    // Načtení programu
    document.getElementById("loadBtn").addEventListener("click", async () => {
      const dateFrom = document.getElementById("dateFrom").value;
      if (!dateFrom) {
        alert("Vyber datum");
        return;
      }
      const days = parseInt(document.getElementById("range").value, 10);
      const q = document.getElementById("q").value.trim().toLowerCase();
      const outEl = document.getElementById("out");
      const statusEl = document.getElementById("status");
      outEl.innerHTML = "";
      statusEl.textContent = "Načítám…";

      const selected = [...listEl.querySelectorAll("input[type=checkbox]:checked")]
        .map(cb => cb.value)
        .filter(v => v && v !== "allCinemas");

      const results = [];

      for (const c of selected) {
        for (let i = 0; i < days; i++) {
          const d = new Date(dateFrom);
          d.setDate(d.getDate() + i);
          const iso = d.toISOString().slice(0,10);
          try {
            const films = await loadProgramForCinema(c, iso);
            results.push({ cinema: c, date: iso, films });
          } catch (e) {
            results.push({ cinema: c, date: iso, error: e.message });
          }
        }
      }

      statusEl.textContent = "";
      results.forEach(r => {
        const div = document.createElement("div");
        div.className = "film";
        div.innerHTML = `<div class="film-title">${CINEMAS.find(x => x.id === r.cinema)?.name} – ${r.date}</div>`;
        if (r.error) {
          div.innerHTML += `<div class="error">${r.error}</div>`;
        } else if (!r.films || r.films.length === 0) {
          div.innerHTML += `<div class="muted">Žádné projekce</div>`;
        } else {
          r.films.forEach(f => {
            if (q && !f.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").includes(q.normalize("NFD").replace(/[\u0300-\u036f]/g,""))) return;
            div.innerHTML += `<div class="show"><span>${f.title}</span><span>${f.shows.map(s => `${s.time}${s.hall ? " ("+s.hall+")":""}`).join(", ")}</span></div>`;
          });
        }
        outEl.appendChild(div);
      });
    });
  </script>
</body>
</html>

